var quoteStorageId,departDatePicker,returnDatePicker,depositDatePicker,paymentDatePicker,step1Url=context+"api/step1.json",step2Url=context+"api/step2.json",step3Url=context+"api/step3.json",resultPageUrl=location.protocol+"//"+location.host+context,updateBaseCacheUrl=context+"api/updateBaseCache",updateFilteredCacheUrl=context+"api/updateFilteredCache",removeFromCacheUrl=context+"api/removeFromCache",depositDatePickerElement=$("#depositDatePicker"),paymentDatePickerElement=$("#paymentDatePicker"),destinationElement=$("#destination"),departDatePickerElement=$("#departDatePicker"),returnDatePickerElement=$("#returnDatePicker"),form1Elements=[destinationElement,departDatePickerElement,returnDatePickerElement],ageElements=$(".ageField"),residenceSelect=$("#residence"),citizenshipSelect=$("#citizenship"),form2Elements=[ageElements,residenceSelect,citizenshipSelect],form3Elements=[depositDatePickerElement,paymentDatePickerElement],confirmZeroCost=!1,confirmZeroCostClass="confirmZeroCost",confirmOneDayDiffClass="confirmOneDayDiff",rb1=$("#customRadio1"),rb2=$("#customRadio2"),step1=$(".step1"),step2=$(".step2"),step3=$(".step3"),tripCost=$(".tripCost"),mainFormTravelers=1,globalCurrentSlide=1;function closeBootstrapSelect(){setTimeout(function(){$(".bootstrap-select").removeClass("open")},150)}function updatePreExistingCondition(e){$("#preExistingCondition").val(e)}function updateTravelers(){var e=$("button[data-id=travelers]").attr("title");if(mainFormTravelers<e)for(var t=0;t<e-mainFormTravelers;t++){$(".form-group.ages > .input-group:last").clone().insertAfter(".form-group.ages > .input-group:last"),$(".form-group.ages > .input-group:last > input").val("");var a=$(".form-group.ages > .input-group:last > input").attr("id").split("-")[1];$(".form-group.ages > .input-group:last > input").attr({id:"age-"+(parseInt(a)+1)}),$(".form-group.ages > .input-group:last").children().removeClass("invalid")}e<mainFormTravelers&&$(".form-group.ages > .input-group").slice(e-mainFormTravelers).remove(),mainFormTravelers=e,ageElements=$(".ageField"),$.each(ageElements,function(e,t){$(t).on("keyup change paste",function(){setTimeout(function(){validateForm2()},0)})}),validateForm2()}function fillAges(){for(var e=[],t=$(".ageField"),a=t.length,i=0;i<a;i++)""!=t[i].value&&e.push(t[i].value);$("#travelersString").val(JSON.stringify(e))}function checkStep1(){if(clearErrors(),validateDate(departDatePicker.val())&&validateDate(returnDatePicker.val())){$("#successVerifiedMailMsg").hide(),$("#errorVerifiedMailMsg").hide(),step1.addClass("disabled-pointer");var e=$("#step1Form").serialize();$.post(step1Url,e,function(e){"success"==e.status?(changeSlide(2),"US"==residenceSelect.val().substring(0,2)&&""==citizenshipSelect.val()&&citizenshipSelect.val("US"),$(".selectpicker").selectpicker("refresh"),validateForm2()):"sessionExpired"==e.status?reloadIfSessionExpired():(clearErrors(),printErrors(e.errors)),step1.removeClass("disabled-pointer")}).fail(function(){printError(null,defErrMsg),step1.removeClass("disabled-pointer")})}else validateDate(departDatePicker.val())||printErrors(JSON.parse('[{"codes":["step1QuoteRequestForm.departDate","departDate","java.util.Date",""],"defaultMessage":"Depart date is invalid","field":"departDate"}]')),validateDate(returnDatePicker.val())||printErrors(JSON.parse('[{"codes":["step1QuoteRequestForm.returnDate","returnDate","java.util.Date",""],"defaultMessage":"Return date is invalid","field":"returnDate"}]'))}function checkStep2(){fillAges(),step2.addClass("disabled-pointer");var e=$("#step2Form").serialize();$.post(step2Url,e,function(e){(clearErrors(),"success"==e.status)?($("#quoteStorageId").val(e.quoteStorageId),e.zeroCost?($("#step2Form").hide(),$("#searchResult").click()):(quoteStorageId=e.quoteStorageId,sendUpdateBasedCache(),changeSlide(3),step2.removeClass("disabled-pointer"),"false"==$("#preExistingCondition").val()&&($("#noPayment").attr("checked",!0),paymentDatePicker.addClass("disabled-filter"),paymentDatePicker.next().addClass("disabled-filter"),paymentDatePicker.attr({placeholder:""}),paymentDatePicker.val(""),updatePreExistingCondition(!1)),validateForm3())):"sessionExpired"==e.status?reloadIfSessionExpired():(printErrors(e.errors),step2.removeClass("disabled-pointer"))}).fail(function(){printError(null,defErrMsg),step2.removeClass("disabled-pointer")})}function checkStep3(){$("#step3QuoteStorageId").val(quoteStorageId);var e=$("#step3Form").serialize();$.post(step3Url,e,function(e){"success"==e.status?window.location.href=resultPageUrl+"comparePlans/?quoteId="+quoteStorageId:"sessionExpired"==e.status?reloadIfSessionExpired():(printErrors(e.errors),step3.removeClass("disabled-pointer"),$(".form3").show())}).fail(function(){step3.removeClass("disabled-pointer"),printError(null,defErrMsg)})}function reloadIfSessionExpired(){"undefined"!=typeof Storage&&(sessionStorage.appSessionExpired=!0),location.reload()}function sendUpdateBasedCache(){$.post(updateBaseCacheUrl,"quoteId="+quoteStorageId).fail(function(){printError(null,defErrMsg)})}function sendUpdateFilteredCache(){$.post(updateFilteredCacheUrl,"quoteId="+quoteStorageId).fail(function(){printError(null,defErrMsg)})}function sendRemoveFromCacheRequest(){quoteStorageId&&$.post(removeFromCacheUrl,"quoteId="+quoteStorageId).fail(function(){printError(null,defErrMsg)})}function printErrors(e){var r,n="";$.each(e,function(e,t){if(t.defaultMessage&&(t.field&&-1==t.field.indexOf("travelers")||-1!=t.field.indexOf("travelers")&&!r)&&(""!=n&&(n+="<br/>"),n+=t.defaultMessage),"travelersString"==t.field)$(".ageField").first().addClass("invalid");else if(-1!=t.field.indexOf("travelers")){r=!0;var a=$(".ageField"),i=t.field.match(/\d+/);$(a[i]).addClass("invalid")}else"destinationCountry"==t.field?destinationElement.parent().find(":button").addClass("invalid"):"residentCountry"==t.field?residenceSelect.parent().find(":button").addClass("invalid"):"citizenCountry"==t.field?citizenshipSelect.parent().find(":button").addClass("invalid"):$("input[name="+t.field+"]").addClass("invalid")}),printError(n,defErrMsg)}function clearErrors(){$(".invalid").removeClass("invalid"),$("#errors").html("")}function validateDate(e){return moment(e,["MM/DD/YYYY"],!0).isValid()}function checkOneDayDiff(e,t){return 1==moment(e,["MM/DD/YYYY"]).diff(moment(t,["MM/DD/YYYY"]),"day")}function changeSlide(e){globalCurrentSlide=e;var t=$(".steps .step-line");t.removeClass("active underline"),t.slice(0,e-1).addClass("underline"),t.slice(0,e).addClass("active");var a=$(".forminfo > .form");a.removeClass("active").hide(),a.eq(e-1).addClass("active").show(),resizeDiv()}function validateForm1(){var a=!1;$.each(form1Elements,function(e,t){0==$(t).val().length&&(a=!0)}),a?($(".step1").addClass("disabled-filter"),disabledStep(2),disabledStep(3)):($(".step1").removeClass("disabled-filter"),enabledStep(2))}function validateForm2(){var a=!1;$.each(form2Elements,function(e,t){0==$(t).val().length&&(a=!0)}),$.each(ageElements,function(e,t){0==$(t).val().length&&(a=!0)}),a?($(".step2").addClass("disabled-filter"),disabledStep(3)):($(".step2").removeClass("disabled-filter"),enabledStep(3))}function validateForm3(){var e=!1;0==$(depositDatePickerElement).val().length&&(e=!0),0!=$(paymentDatePickerElement).val().length||$("#noPayment").prop("checked")||(e=!0),e?$(".step3").addClass("disabled-filter"):$(".step3").removeClass("disabled-filter")}function enabledStep(e){$(".step-line-"+e).removeClass("disabled-filter")}function disabledStep(e){$(".step-line-"+e).addClass("disabled-filter")}String.prototype.reverse=function(){return this.split("").reverse().join("")},$(document).ready(function(){$(".timezoneOffset").val((new Date).getTimezoneOffset()),$("#destination, #citizenship").find('option[value="US"]').attr("data-tokens","usa united states"),departDatePicker=$("#departDatePicker").datepicker({orientation:"bottom auto",autoclose:!0,startDate:"+1d"}).on("show",function(){closeBootstrapSelect()}).on("changeDate",function(){var e=moment(new Date(this.value));e.add(1,"d"),returnDatePicker.datepicker("setStartDate",e.toDate());var t=$(this).closest("form").find(":input");departDatePicker.datepicker("hide"),t.eq(t.index(this)+1).focus(),validateForm1()});var e=moment(new Date);e.add(1,"d"),departDatePicker.datepicker("setStartDate",e.toDate()),returnDatePicker=$("#returnDatePicker").datepicker({orientation:"bottom auto",autoclose:!0,startDate:"+1d"}).on("show",function(){closeBootstrapSelect()}).on("changeDate",function(){var e=$(this).closest("form").find(":input");returnDatePicker.datepicker("hide"),e.eq(e.index(this)+1).focus(),validateForm1()});function a(){var e=$("#"+confirmZeroCostClass+"Val").val(),t=$("#"+confirmOneDayDiffClass+"Val").val();"true"==e||0<parseFloat(tripCost.val().replace(/,/g,""))?"true"!=t&&checkOneDayDiff(returnDatePicker.val(),departDatePicker.val())?showModal({title:"Check fields",text:mOneDayDiff,type:"error",fontSize:18,confirm:!0,confirmClass:confirmOneDayDiffClass,callback:a}):checkStep1():showModal({title:"Check fields",text:mTripCostNotSet,type:"error",fontSize:18,confirm:!0,confirmClass:confirmZeroCostClass,callback:a})}function t(e){$("#includesUS").val(e),checkStep2()}depositDatePicker=$("#depositDatePicker").datepicker({orientation:"bottom auto",autoclose:!0,endDate:"new Date()"}).on("changeDate",function(){moment(depositDatePicker.val(),["MM/DD/YYYY"],!0).isValid()&&("true"==$("#preExistingCondition").val()&&paymentDatePicker.datepicker("setStartDate",this.value),depositDatePicker.datepicker("hide"))}),paymentDatePicker=$("#paymentDatePicker").datepicker({orientation:"bottom auto",autoclose:!0,startDate:depositDatePicker.val()}).on("changeDate",function(){if(moment(paymentDatePicker.val(),["MM/DD/YYYY"],!0).isValid()){null==depositDatePicker.datepicker("getDate")&&(!0,depositDatePicker.datepicker("setDate",paymentDatePicker.val()));var e=$(this).closest("form").find(":input");paymentDatePicker.datepicker("hide"),e.eq(e.index(this)+1).focus()}}),$(".prev").click(function(){changeSlide($(this).attr("data")-1),sendRemoveFromCacheRequest()}),$(".step-line > span, .step-line > .round").click(function(e){e.stopPropagation();var t=$(this).parents(".step-line").index(".step-line");globalCurrentSlide<=t?1==t?checkStep1():2==t?checkStep2():3==t&&checkStep3():changeSlide(t+1)}),$(".selectpicker").selectpicker({liveSearch:!0,liveSearchStyle:"contains",selectOnTab:!0}),$(".ageSelectpicker").selectpicker(),""==destinationElement.val()&&$(".bootstrap-select [data-id=destination] .filter-option").text("Choose a Destination"),""==residenceSelect.val()&&$(".bootstrap-select [data-id=residence] .filter-option").text("Choose a Residence"),""==citizenshipSelect.val()&&$(".bootstrap-select [data-id=citizenship] .filter-option").text("Choose a Citizenship"),residenceSelect.on("change",function(){"US"==$(this).val().substring(0,2)&&""==citizenshipSelect.val()&&(citizenshipSelect.val("US"),citizenshipSelect.selectpicker("refresh"))}),step1.click(function(e){e.preventDefault(),a()}),step2.click(function(e){e.preventDefault(),"US"==$("#destination").val()||"US"==$("#residence").val().substring(0,2)?($("#includesUS").val(!0),checkStep2()):showIncludesUSModal(t)}),step3.click(function(e){step3.addClass("disabled-pointer"),e.preventDefault(),checkStep3()}),tripCost.autoNumeric("init",{aSep:",",aPad:!1,dGroup:"3",aDec:".",vMin:"0.00",vMax:"9999999.99"}),tripCost.keyup(function(){var e=tripCost.val();/\.00$/.test(e)&&tripCost.val(e.replace(/\.00$/,""))}),3==$("#currentStep").val()&&(checkStep1(),checkStep2()),$("#notificationModal").modal("show"),$("#registrationCompletedModal").modal("show"),$("#registrationCompletedModal").on("shown.bs.modal",function(){var e=$(this);clearTimeout(e.data("hideInteval")),e.data("hideInterval",setTimeout(function(){e.modal("hide")},1e3))}),rb1.on("keydown",function(e){9==e.keyCode&&(e.preventDefault(),rb2.focus())}),rb2.on("keydown",function(e){9==e.keyCode&&(e.preventDefault(),step1.focus())}),step1.on("keydown",function(e){9==e.keyCode&&(e.preventDefault(),$('[data-id="destination"]').click())}),$(".citizenship-bootstrap-select").on("keydown",function(e){9==e.keyCode&&(e.preventDefault(),step2.focus())}),step2.on("keydown",function(e){9==e.keyCode&&(e.preventDefault(),$("#travelers0\\.age").focus())}),depositDatePickerElement.on("keydown",function(e){9==e.keyCode&&e.preventDefault()}),"undefined"!=typeof Storage&&"true"==sessionStorage.getItem("appSessionExpired")&&($("#expiredSessionModal").modal("show"),sessionStorage.appSessionExpired=!1);var i=$("#mainFormTravelersCount").val();0<i&&(mainFormTravelers=i),$(".input-group-addon").on("click",function(){$(this).prev("input").datepicker("show")}),$("#noPayment").change(function(e){e.target.checked?(paymentDatePicker.addClass("disabled-filter"),paymentDatePicker.next().addClass("disabled-filter"),paymentDatePicker.attr({placeholder:""}),paymentDatePicker.val(""),updatePreExistingCondition(!1)):(paymentDatePicker.removeClass("disabled-filter"),paymentDatePicker.next().removeClass("disabled-filter"),paymentDatePicker.attr({placeholder:"Select a Date"}),updatePreExistingCondition(!0)),validateForm3()}),$.each(form1Elements,function(e,t){$(t).on("change",function(){validateForm1()})}),$.each(form2Elements,function(e,t){$(t).on("change",function(){validateForm2()})}),$.each(ageElements,function(e,t){$(t).on("keyup change paste",function(){setTimeout(function(){validateForm2()},0)})}),$.each(form3Elements,function(e,t){$(t).on("change",function(){validateForm3()})}),validateForm1(),validateForm2(),validateForm3()}),$(".bootstrap-select").on("hidden.bs.dropdown",function(e){switch($(e.target).children().attr("data-id")){case"travelers":updateTravelers()}});